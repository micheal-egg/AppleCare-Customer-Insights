<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AppleCare Customer Insights</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <!-- Header Bar -->
  <header class="topbar">
    <div class="branding">
    <!-- Use url_for to reference static files, so we are using flask, no more local saves -->
      <img src="{{ url_for('static', filename='apple-logo.png') }}" alt="Apple Logo">
      <h1>AppleCare Customers Insights</h1>
    </div>
  </header>

  <!-- Controls -->
<div class="box">
  <section class="controls">
    <div class="control-row">
      <div class="field">
        <span class="field-title">Keyword Search</span>
        <input id="q" placeholder="e.g., activation, battery">
      </div>

      <div class="field">
        <span class="field-title">Minimum Rating</span>
        <select id="min_rating">
          <option selected>1</option><option>2</option><option>3</option>
          <option>4</option><option>5</option>
        </select>
      </div>

      <div class="field">
        <span class="field-title">Month</span>
        <input id="month" type="month">
      </div>

      <div class="field">
        <span class="field-title">Region</span>
        <select id="region">
          <option>ALL</option><option>US</option><option>EU</option>
          <option>APAC</option><option>LATAM</option>
        </select>
      </div>

      <div class="actions">
        <button onclick="run()">Search</button>
        <button onclick="loadSummary()">Summary</button>
      </div>
    </div>
  </section>
</div>

  <!-- Results Table -->
  <section class="results">
    <h3>Survey Results</h3>
    <table id="tbl">
      <thead>
            <tr>
              <th>Date</th>
              <th>Product</th>
              <th>Region</th>
              <th>Rating</th>
              <th>Comment</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div style="display:flex;justify-content:center;margin:1rem 0;">
        <button id="showMoreBtn" onclick="showMore()" style="display:none;">
        Show more
         </button>
        </div>
      </section>
  

  <!-- Summary Table -->
  <section class="summary">
    <h3>Monthly Summary</h3>
    <table id="summary">
      <thead>
        <tr>
          <th>Month</th>
          <th>Region</th>
          <th>Count</th>
          <th>Avg Rating</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Scripts -->
<script>
  // Tracks number of rows loaded 
  let currentOffset = 0;
  // Number of rows to load per request
  const PAGE_SIZE = 50;

  function buildSearchURL(limit, offset){
    const q = document.getElementById('q').value;
    const r = document.getElementById('min_rating').value;
    const m = document.getElementById('month').value;
    const reg = document.getElementById('region').value;

    const url = new URL(`/api/search`, location.origin);
    if (q) url.searchParams.set('q', q);
    url.searchParams.set('min_rating', r);
    if (m) url.searchParams.set('month', m);
    if (reg && reg !== 'ALL') url.searchParams.set('region', reg);

    url.searchParams.set('limit', limit);
    url.searchParams.set('offset', offset);

    return url;
  }

  function colorCodeRatings(){
    document.querySelectorAll('.rating').forEach(td => {
      const val = parseInt(td.textContent);
      if (val <= 2) td.style.color = "#e74c3c";
      else if (val === 3 || val === 4) td.style.color = "#f1c40f";
      else td.style.color = "#27ae60";
    });
  }

  async function run(){
    // reset offset
    currentOffset = 0;

    const tb = document.querySelector('#tbl tbody');
    tb.innerHTML = '';

    await fetchAndRender(PAGE_SIZE, currentOffset, /*append=*/false);
  }

  async function showMore(){
    //Adds Rows to existing table
    currentOffset += PAGE_SIZE;
    await fetchAndRender(PAGE_SIZE, currentOffset, /*append=*/true);
  }

  async function fetchAndRender(limit, offset, append){
    const url = buildSearchURL(limit, offset);

    const res = await fetch(url);
    const data = await res.json();

    const tb = document.querySelector('#tbl tbody');

    // Append rows (table already cleared in run())
    for (const row of data){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.submitted_at ?? ''}</td>
        <td>${row.product_line ?? ''}</td>
        <td>${row.region ?? ''}</td>
        <td class="rating">${row.rating ?? ''}</td>
        <td>${row.comment_clean ?? ''}</td>`;
      tb.appendChild(tr);
    }

    colorCodeRatings();

    // Show/hide the button:
    // If we received fewer than PAGE_SIZE, there are no more rows.
    const btn = document.getElementById('showMoreBtn');
    if (data.length === PAGE_SIZE) {
      btn.style.display = 'inline-block';
    } else {
      btn.style.display = 'none';
    }
  }

  async function loadSummary(){
    const m = document.getElementById('month').value;
    const reg = document.getElementById('region').value;

    const url = new URL(`/api/summary`, location.origin);
    if (m) url.searchParams.set('month', m);
    if (reg && reg !== 'ALL') url.searchParams.set('region', reg);

    const res = await fetch(url);
    const data = await res.json();

    const tb = document.querySelector('#summary tbody');
    tb.innerHTML = '';
    for (const row of data){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.month ?? ''}</td>
        <td>${row.region ?? ''}</td>
        <td>${row.count ?? 0}</td>
        <td>${row.avg_rating ?? ''}</td>`;
      tb.appendChild(tr);
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('q').addEventListener('keydown', e => {
      if (e.key === 'Enter') run();
    });

    run();        // loads first 50
    loadSummary();
  });
</script>
</body>
</html>




